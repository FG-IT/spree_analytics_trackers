<% if defined?(ga_enabled?) && ga_enabled? && @order.present? %>
  <script>
    window.addEventListener('turbolinks:load', function() {
      if (typeof gtag !== 'undefined') {
        clearGAplugins();
        gtag('event', 'purchase', {
          transaction_id: '<%= @order.number %>',
          value: <%= @order.total&.to_f %>,
          currency: '<%= @order.currency %>',
          tax: <%= @order.tax_total&.to_f %>,
          shipping: <%= @order.shipment_total&.to_f %>,
          coupon: '<%= @order.promo_code %>',
          items: [
            <% @order.line_items.each do |line_item| %>
              <%= ga_line_item(line_item) %>,
            <% end %>
          ]
        });

        gtag('set', 'user_data', {
          'email': "<%= @order.email %>",
          <% unless @order&.ship_address&.phone.blank? %>
          'phone_number': "<%= @order.ship_address.phone %>",
          <% end %>
          'address': {
            'first_name': "<%= @order&.ship_address&.firstname %>",
            'last_name': "<%= @order&.ship_address&.lastname %>",
            'street': "<%= @order&.ship_address&.address1 %>",
            'city': "<%= @orderi&.ship_address&.city %>",
            'region': "<%= @order&.ship_address&.state_text %>",
            'postal_code': "<%= @order&.ship_address&.zipcode %>",
            'country':  "<%= @order&.ship_address&.country&.iso %>"
          }
        });
      }
    });
  </script>
<% end %>
