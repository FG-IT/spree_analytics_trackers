<% if (defined?(ga_enabled?) && ga_enabled?) || (defined?(ga4_enabled?) && ga4_enabled?) %>
<script type="text/javascript" data-turbolinks-eval="false">
window.addEventListener('turbolinks:load', function () {
  if (!PRODUCT_ID) {
    return;
  }

  var cartForm = $('.add-to-cart-form');
  if (cartForm.length <= 0) {
    return;
  }

  var variant = null;
  if (Spree) {
    variant = Spree.variantById($(ADD_TO_CART_FORM_SELECTOR), $(VARIANT_ID_SELECTOR).val());
  } else {
    var variantId = $('[name="variant_id"]').val();
    var variants = JSON.parse(cartForm.attr('data-variants'));

    variant = variants.find(function(variant) { return variant.id.toString() === variantId; }) || null;
  }

  if (!variant) {
    return;
  }

  var store_code = "<%= current_store.code %>";
  var current_country = "<%= current_country || "US" %>";
  var productSummary = JSON.parse(cartForm.attr('data-product-summary'));
  var price = parseFloat(variant.price);
  var item_id =  [store_code,current_country, PRODUCT_ID, variant.id].join('_')
  <% if defined?(ga_enabled?) && ga_enabled? %>
  gtag('event', 'view_item', {
    'send_to': '<%= ga_tracker.analytics_id %>',
    'value': price,
    'currency': variant.currency,
    'items': [{
      id: item_id,
      name: productSummary.name,
      brand: productSummary.brand,
      price: price,
      quantity: 10,
    }]
  });
  <% end %>

  <% if defined?(ga4_enabled?) && ga4_enabled? %>
  gtag('event', 'view_item', {
    'send_to': '<%= ga4_tracker.analytics_id %>',
    'value': price,
    'currency': variant.currency,
    'items': [{
      item_id: item_id,
      item_name: productSummary.name,
      item_brand: productSummary.brand,
      price: price,
      quantity: 10,
    }]
  });
  <% end %>

  <%
if defined?(gads_enabled?) && gads_enabled?
  google_ads_conversion_id = gads_tracker.analytics_id.include?('AW-') ? gads_tracker.analytics_id : "AW-#{gads_tracker.analytics_id}"
%>

  gtag('event', 'view_item', {
    'send_to': '<%= google_ads_conversion_id %>',
    'value': price,
    'currency': variant.currency,
      'items': [{
      item_id: item_id,
      item_name: productSummary.name,
      item_brand: productSummary.brand,
      price: price,
      quantity: 10,
    }]
  });

  <% end %>

  //console.log(item_id)
});

</script>
<% end %>
