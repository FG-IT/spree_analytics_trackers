<% if (defined?(ga_enabled?) && ga_enabled?) || (defined?(ga4_enabled?) && ga4_enabled?) %>
<script type="text/javascript" data-turbolinks-eval="false">
window.addEventListener('turbolinks:load', function () {
  if (!PRODUCT_ID) {
    return;
  }

  var cartForm = $('.add-to-cart-form');
  if (cartForm.length <= 0) {
    return;
  }

  var variant = null;
  if (Spree) {
    variant = Spree.variantById($(ADD_TO_CART_FORM_SELECTOR), $(VARIANT_ID_SELECTOR).val());
  } else {
    var variantId = $('[name="variant_id"]').val();
    var variants = JSON.parse(cartForm.attr('data-variants'));

    variant = variants.find(function(variant) { return variant.id.toString() === variantId; }) || null;
  }

  if (!variant) {
    return;
  }

  var store_code = "<%= current_store.code %>";
  var productSummary = JSON.parse(cartForm.attr('data-product-summary'));
  var price = parseFloat(variant.price);
  <% if defined?(ga_enabled?) && ga_enabled? %>
  gtag('event', 'view_item', {
    'send_to': '<%= ga_tracker.analytics_id %>',
    'value': price,
    'currency': variant.currency,
    'items': [{
      id: [store_code, variant.product_id, variant.id].join('_'),
      name: productSummary.name,
      brand: productSummary.brand,
      price: price,
      quantity: 10,
    }]
  });
  <% end %>

  <% if defined?(ga4_enabled?) && ga4_enabled? %>
  gtag('event', 'view_item', {
    'send_to': '<%= ga4_tracker.analytics_id %>',
    'value': price,
    'currency': variant.currency,
    'items': [{
      item_id: [store_code, variant.product_id, variant.id].join('_'),
      item_name: productSummary.name,
      item_brand: productSummary.brand,
      price: price,
      quantity: 10,
    }]
  });
  <% end %>
});
</script>
<% end %>
