<% if defined?(matomo_enabled?) && matomo_enabled? %>
<script type="text/javascript" data-turbolinks-eval="false">
  (function() {
    var previousPageUrl = null;
    window.addEventListener('turbolinks:load', function(event) {
      var _paq = window._paq = window._paq || [];
      if (previousPageUrl) {
        _paq.push(['setReferrerUrl', previousPageUrl]);
        _paq.push(['setCustomUrl', window.location.href]);
        _paq.push(['setDocumentTitle', document.title]);
        if (event.data && event.data.timing) {
          _paq.push(['setPagePerformanceTiming', event.data.timing.visitEnd - event.data.timing.visitStart]);
        }
      }
      <% if user_id = try_spree_current_user.try(:email) %>
      _paq.push(['setUserId', "<%= user_id %>"]);
      <% end %>

      console.log('PRODUCT_ID: ' + PRODUCT_ID);
      if (PRODUCT_ID) {
        var variant = null;
        var cartForm = $('.add-to-cart-form');
        if (cartForm.length > 0) {
          var productSummary = JSON.parse(cartForm.attr('data-product-summary'));
          var breadcrumbs = $('#breadcrumbs li.breadcrumb-item').map(function() { return $(this).text().trim(); }).get();
          breadcrumbs.shift();
          var last = breadcrumbs[breadcrumbs.length - 1];
          if (last && last.length > 30) {
            breadcrumbs.pop();
          }
          if (Spree) {
            variant = Spree.variantById($(ADD_TO_CART_FORM_SELECTOR), $(VARIANT_ID_SELECTOR).val());
          } else {
            var variantId = $('[name="variant_id"]').val();
            var variants = JSON.parse(cartForm.attr('data-variants'));

            variant = variants.find(function(variant) { return variant.id.toString() === variantId; }) || null;
          }
          console.log(productSummary);
          console.log(breadcrumbs);
          console.log(variant);
          if (variant) {
            // Push Product View Data to Matomo - Populate parameters dynamically
            _paq.push(['setEcommerceView', variant.sku, productSummary.name, breadcrumbs, variant.price]);
          }

          /*
          cartForm.on('product_add_to_cart', function(event, variant, quantity_increment, cart) {
            if (variant) {
              var variantPrice = parseFloat(variant.price);
              _paq.push(['addEcommerceItem', variant.sku, productSummary.name, breadcrumbs, variantPrice, quantity_increment]);
              _paq.push(['trackEcommerceCartUpdate', variantPrice]); 
            }
          });
          */
        }
      }

      _paq.push(['trackPageView']);
      _paq.push(['enableLinkTracking']);

      previousPageUrl = window.location.href;
    });
  })();
</script>
<% end %>
